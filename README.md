# 🧭 AI‑помощник туриста — тестовое задание GORKYCODE 2025

Прототип сервиса, который формирует **персональный маршрут прогулки по Нижнему Новгороду** на основе интересов пользователя, его доступного времени и местоположения.  
Разработан в рамках тестового задания хакатона **GORKYCODE 2025**.

---

## 🚀 Основная идея

Пользователь отвечает на 3 вопроса в Telegram‑боте:

1. **Интересы** (например: «стрит‑арт, история, кофейни»);
2. **Свободное время** в часах (можно дробное число, например 1.5);
3. **Текущее местоположение** (адрес, координаты или геопозиция).

Бот подбирает реальные точки в Нижнем Новгороде, строит оптимальный маршрут с учётом времени на ходьбу и осмотр и формирует **текст‑гид** с пояснением: *«почему идём именно туда»*.

---

## 🗂 Структура проекта

```text
bitter_test/
├── data/                      # Исходные данные (датасет культурных объектов)
├── osrm/                      # Локальный контейнер OSRM для расчёта маршрутов
├── qdrant_storage/            # Хранилище векторного поиска Qdrant
├── src/
│   ├── routes/
│   │   ├── app.py                # Telegram-бот (основная логика и FSM-диалог)
│   │   ├── cultural_qdrant.py    # Индексация и поиск по культурным объектам
│   │   ├── geo_search.py         # Семантический + гео-реранкинг
│   │   ├── route_builder_foot.py # Построение маршрута и генерация карты Folium
│   │   ├── route_builder_limit.py# Ограничение маршрута по времени
│   │   ├── utils.py              # Геокодер и вспомогательные функции
│   │   └── gorky_guide.py        # Генерация текстового гида через Google Gemini
├── docker-compose.yml         # Локальный запуск OSRM + Qdrant
├── .env / env_example         # Переменные окружения (токены, ключи API)
└── requirements.txt           # Python-зависимости
```

---

## 🧭 Навигация по коду

### Точки входа
- **`src/app.py`** — вход бота и мини‑веб‑сервера.  
  FSM‑диалог: сбор интересов → времени → локации.  
  `finalize_route(...)` — главный оркестратор: вызывает подбор точек, конструирует HTML‑карту, генерирует текст‑гайд и отправляет ссылку пользователю.

### Подбор мест и маршрутизация
- **`src/geo_search.py`**  
  `semantic_topk(...)` — чисто семантический топ (без географии) для пометки «основных» точек.  
  `semantic_proximity_rerank(...)` — семантика + гео‑близость (e^{-d/τ}), итоговый скор для ранжирования кандидатов рядом с пользователем.  
  Важные аргументы: `alpha` (вес семантики vs гео), `geo_tau_km` (как быстро затухает гео‑вес), `hard_drop_km` (жёсткий радиус отсечения).

- **`src/route_builder_limit.py`** *(основной планировщик маршрута; см. `plan_route_under_budget` внутри)*  
  `plan_route_under_budget(...)` — выбирает N первых кандидатов, ищет порядок обхода (**nearest neighbor + 2‑opt**), проверяет, что суммарное время ≤ бюджет, генерирует HTML‑карту.  
  Управляет: количеством «главных» (`main_semantic_k`), балансом семантики/гео (`alpha`, `geo_tau_km`), скоростью ходьбы (`pace_scale`), длительностью остановок по ролям (15 мин для `main`, 3 мин для `additional`).

- **`src/route_builder_foot.py`**  
  Запросы к OSRM: `osrm_table(...)` (матрица длительностей/дистанций), `osrm_route(...)` (линия на карте).  
  Построение карты Folium: `build_walking_route(...)` — рисует полилинию, маркеры, стрелки направления, блок «Легенда маршрута».  
  Эвристики маршрута: `nearest_neighbor(...)`, `two_opt(...)`.

### Данные и поиск
- **`src/cultural_qdrant.py`**  
  Индексация датасета в **Qdrant** с эмбеддингами **intfloat/multilingual‑e5‑large**.  
  `recreate_and_index(...)` — загрузка Excel → генерация векторов → upsert в Qdrant.  
  `Searcher.search(...)` — быстрый поиск top‑k по эмбеддингам.  
  Карта категорий `CATEGORY_MAP` и формирование текста для эмбеддинга `text_for_embedding(...)`.

### Гайд по маршруту
- **`src/gorky_guide.py`** 
  `get_reason(...)` — запрос в **Google Gemini** для генерации JSON‑гайда (intro / mains / extras / outro).  
  `render_guide_text(...)` — аккуратный текст для Telegram из JSON‑структуры.

### Вспомогательное
- **`src/utils.py`** — утилиты, например `geocode_nominatim(...)` (поиск адресов через Nominatim).  
- **`src/routes/`** — папка, куда складываются сгенерированные HTML‑маршруты; статика раздаётся мини‑веб‑сервером в `app.py`.

---

## 🔄 Поток данных (верхнеуровнего)

```text
Telegram -> app.py (FSM)
  ├─ интересы, часы, локация
  ├─ plan_route_under_budget(...)
  │   ├─ geo_search.semantic_topk(...)              (семантические "главные")
  │   ├─ geo_search.semantic_proximity_rerank(...)  (семантика + гео)
  │   ├─ route_builder_foot.osrm_table/route(...)   (OSRM)
  │   ├─ nearest_neighbor + two_opt                 (порядок)
  │   └─ build_walking_route(...) -> HTML карта + легенда
  ├─ gorky_guide.get_reason(...)  -> JSON
  ├─ gorky_guide.render_guide_text(...) -> текст
  └─ отправка текста + кнопки «Открыть маршрут»
```
